<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRunner v1.8 (Safari Proof)</title>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin:0; background:#0f172a; color:#f8fafc; font-family:sans-serif; display:flex; flex-direction:column; height:100vh; overflow:hidden; }
        header { padding:10px 20px; border-bottom:1px solid #334155; display:flex; align-items:center; justify-content:space-between; background:#1e293b; }
        #log { height:50px; background:#000; font-family:monospace; font-size:11px; padding:8px 20px; overflow-y:auto; color:#94a3b8; border-bottom:1px solid #334155; }
        #container { flex-grow:1; margin:10px; background:#fff; border-radius:12px; overflow:hidden; }
        iframe { width:100%; height:100%; border:none; }
    </style>
</head>
<body>

<header>
    <div style="font-weight:900;">WebRunner <span style="color:#60a5fa;">v1.8</span></div>
    <input type="file" id="fileInput" accept=".html,.js,.jsx">
</header>

<div id="log">READY: Safari互換モードで待機中...</div>

<main id="container">
    <iframe id="viewer"></iframe>
</main>

<script>
    const fileInput = document.getElementById('fileInput');
    const log = document.getElementById('log');
    const viewer = document.getElementById('viewer');

    function addLog(msg, isError = false) {
        const div = document.createElement('div');
        if (isError) div.style.color = '#f87171';
        div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        log.appendChild(div);
        log.scrollTop = log.scrollHeight;
    }

    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files;
        if (!file) return;

        addLog(`読込: ${file.name}`);
        const rawCode = await file.text();

        try {
            if (file.name.endsWith('.html')) {
                viewer.srcdoc = rawCode;
                addLog("HTMLを表示しました");
                return;
            }

            addLog("Babelトランスパイル中...");

            // 1. import文を完全に削除（Safariのモジュールエラー対策）
            const noImportCode = rawCode.replace(/import\s+.*?\s+from\s+['"].*?['"];?/g, '');

            // 2. BabelでJSX -> JS (ES5/ES6) に変換
            const { code } = Babel.transform(noImportCode, {
                presets: ['react'],
                filename: 'app.jsx'
            });

            // 3. export default を変数 App に変換
            const runnerCode = code
                .replace(/export\s+default\s+function\s+([A-Z][A-Za-z0-9]*)/, 'function $1')
                .replace(/export\s+default\s+/, 'var App = ');

            // 4. iframeの中に流し込むHTMLを作成
            // 全ての依存関係を UMD (Global変数) 形式で読み込む
            const sandboxHtml = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.tailwindcss.com"><\/script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"><\/script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"><\/script>
    <script src="https://unpkg.com/lucide@latest"><\/script>
</head>
<body style="margin:0;">
    <div id="root"></div>
    <script>
        (function() {
            try {
                const { useState, useEffect, useRef, useMemo, useCallback } = React;
                
                // Lucideアイコンをグローバルに展開
                if (window.lucide) {
                    Object.keys(window.lucide.icons).forEach(key => {
                        window[key] = window.lucide.icons[key];
                    });
                }

                // ユーザーコード実行
                ${runnerCode}

                // Appの起動
                const Target = (typeof App !== 'undefined') ? App : null;
                if (!Target) throw new Error("Appコンポーネントが見つかりませんでした。");

                const root = ReactDOM.createRoot(document.getElementById('root'));
                root.render(React.createElement(Target));

                // Lucideアイコンの置換
                setTimeout(() => { if(window.lucide) lucide.createIcons(); }, 100);
            } catch (err) {
                document.body.innerHTML = '<pre style="color:red;padding:20px;white-space:pre-wrap;">' + err.message + '</pre>';
            }
        })();
    <\/script>
</body>
</html>`;

            viewer.srcdoc = sandboxHtml;
            addLog("Reactアプリケーションを起動しました");

        } catch (err) {
            addLog(`変換エラー: ${err.message}`, true);
        }
    });
</script>

</body>
</html>

