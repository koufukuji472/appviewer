<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Web Runner</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { margin: 0; display: flex; flex-direction: column; height: 100vh; font-family: sans-serif; }
        #launcher { padding: 15px; background: #1e293b; color: white; display: flex; align-items: center; gap: 15px; z-index: 100; }
        #display-area { flex-grow: 1; position: relative; background: #f8fafc; overflow: auto; }
        iframe { width: 100%; height: 100%; border: none; }
        .mode-badge { font-size: 0.7em; padding: 2px 8px; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="launcher">
        <span style="font-weight:bold; white-space:nowrap;">Web Runner</span>
        <input type="file" id="fileInput" accept=".txt,.js,.jsx,.html" style="font-size: 0.8em;">
        <div id="status" class="mode-badge"></div>
    </div>

    <div id="display-area">
        <div id="react-root"></div>
        <iframe id="html-frame" style="display:none;"></div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const statusEl = document.getElementById('status');
        const reactRoot = document.getElementById('react-root');
        const htmlFrame = document.getElementById('html-frame');

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files;
            if (!file) return;

            const code = await file.text();
            
            // --- 1. HTMLかReactかの自動判別 ---
            const isHTML = code.trim().toLowerCase().startsWith('<!doctype') || code.includes('<html');

            if (isHTML) {
                renderAsHTML(code);
            } else {
                renderAsReact(code);
            }
        });

        // --- HTMLとして表示する処理 ---
        function renderAsHTML(code) {
            statusEl.innerText = "MODE: HTML";
            statusEl.style.background = "#3b82f6";
            
            reactRoot.innerHTML = ""; // Reactを消す
            htmlFrame.style.display = "block";
            
            // iframeのsrcdocに流し込むことで、独立したページとして実行
            htmlFrame.srcdoc = code;
        }

        // --- Reactとして表示する処理 ---
        function renderAsReact(code) {
            statusEl.innerText = "MODE: REACT";
            statusEl.style.background = "#8b5cf6";
            
            htmlFrame.style.display = "none";
            reactRoot.innerHTML = "コンパイル中...";

            try {
                // Babelで翻訳
                const cleanCode = code.replace(/^import.*from.*;/gm, '');
                const transformedCode = Babel.transform(cleanCode, { presets: ['react'] }).code;

                const fullCode = `
                    const { useState, useEffect, useRef } = React;
                    const { ${Object.keys(Lucide).join(', ')} } = Lucide;
                    ${transformedCode}
                    const root = ReactDOM.createRoot(document.getElementById('react-root'));
                    root.render(React.createElement(App));
                `;

                reactRoot.innerHTML = "";
                new Function('React', 'ReactDOM', 'Lucide', fullCode)(React, ReactDOM, Lucide);
                lucide.createIcons();
            } catch (err) {
                reactRoot.innerHTML = `<div style="color:red; padding:20px;">Reactエラー: ${err.message}</div>`;
            }
        }
    </script>
</body>
</html>
