<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRunner v1.7 (Stable)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { margin:0; background:#0f172a; color:#f8fafc; font-family:sans-serif; display:flex; flex-direction:column; height:100vh; }
        header { padding:10px 20px; border-bottom:1px solid #334155; display:flex; align-items:center; gap:15px; background:#1e293b; }
        #log { height:60px; background:#000; font-family:monospace; font-size:12px; padding:10px; overflow-y:auto; color:#94a3b8; border-bottom:1px solid #334155; }
        main { flex-grow:1; margin:10px; background:#fff; border-radius:8px; overflow:hidden; position:relative; }
        iframe { width:100%; height:100%; border:none; background:white; }
        .error { color:#f87171; }
    </style>
</head>
<body>

<header>
    <b style="font-size:1.2em;">WebRunner <span style="color:#60a5fa;">v1.7</span></b>
    <input type="file" id="fileInput" accept=".html,.js,.jsx">
</header>

<div id="log">READY: ファイルを待機中...</div>

<main id="container">
    <iframe id="viewer"></iframe>
</main>

<script type="module">
    const fileInput = document.getElementById('fileInput');
    const log = document.getElementById('log');
    const viewer = document.getElementById('viewer');

    function addLog(msg, isError = false) {
        const div = document.createElement('div');
        if (isError) div.className = 'error';
        div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        log.appendChild(div);
        log.scrollTop = log.scrollHeight;
    }

    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files;
        if (!file) return;

        addLog(`読込開始: ${file.name}`);
        const rawCode = await file.text();

        try {
            let finalHtml = "";

            if (file.name.endsWith('.html')) {
                finalHtml = rawCode;
            } else {
                addLog("React/JSXを変換中...");
                
                // 1. import文を CDN(esm.sh) に自動書き換え
                // 例: from 'react' -> from 'https://esm.sh/react'
                const processedCode = rawCode.replace(
                    /from\s+['"]([^'"]+)['"]/g, 
                    (match, path) => {
                        if (path.startsWith('http') || path.startsWith('.') || path.startsWith('/')) return match;
                        return `from 'https://esm.sh/${path}'`;
                    }
                );

                // 2. Babelでトランスパイル
                const { code } = Babel.transform(processedCode, {
                    presets: ['react', 'env'],
                    filename: 'app.jsx'
                });

                // 3. 実行用のHTMLテンプレートを作成
                finalHtml = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.tailwindcss.com"><\/script>
    <script src="https://unpkg.com/lucide@latest"><\/script>
</head>
<body>
    <div id="root"></div>
    <script type="module">
        import React from 'https://esm.sh/react@18';
        import ReactDOM from 'https://esm.sh/react-dom@18/client';
        
        // 外部から読み込めるようにグローバルに配置
        window.React = React;
        window.ReactDOM = ReactDOM;

        try {
            ${code.replace('export default', 'const App =')}
            
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(React.createElement(typeof App !== 'undefined' ? App : () => <div>Appが見つかりません</div>));
            
            // Lucideアイコンの自動適用
            setTimeout(() => { if(window.lucide) lucide.createIcons(); }, 100);
        } catch (err) {
            document.body.innerHTML = \`<pre style="color:red;padding:20px;">\${err.stack}<\/pre>\`;
        }
    <\/script>
</body>
</html>`;
            }

            // 4. Blob URLを作成してiframeに流し込む（これが一番確実）
            const blob = new Blob([finalHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            viewer.src = url;

            addLog("レンダリング完了");

        } catch (err) {
            addLog(`エラー: ${err.message}`, true);
            console.error(err);
        }
    });
</script>

</body>
</html>

