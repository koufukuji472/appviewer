 <!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HTML App Viewer</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- lucide icons (CDN) -->
  <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="min-h-screen bg-slate-50 text-slate-900 font-sans p-4 md:p-8">
  <div class="max-w-5xl mx-auto space-y-6">

    <!-- Header -->
    <header class="text-center space-y-2">
      <div class="inline-flex items-center justify-center p-3 bg-indigo-600 text-white rounded-2xl shadow-lg mb-4">
        <i data-lucide="monitor" class="w-8 h-8"></i>
      </div>
      <h1 class="text-3xl font-bold tracking-tight text-slate-800">HTML App Viewer</h1>
      <p class="text-slate-500 max-w-md mx-auto">ローカルのHTMLファイルを安全に実行・プレビューします。</p>
    </header>

    <!-- Control bar -->
    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col md:flex-row items-center justify-between gap-4">
      <div class="flex items-center gap-3 w-full md:w-auto">
        <input id="fileInput" type="file" accept=".html,.htm,text/html" class="hidden" />

        <button id="pickBtn"
          class="flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-xl font-semibold transition-all active:scale-95 shadow-md shadow-indigo-100 w-full md:w-auto">
          <i data-lucide="file-up" class="w-5 h-5"></i>
          <span>ファイルを選択</span>
        </button>

        <button id="resetBtn"
          class="hidden p-3 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-xl transition-colors flex items-center gap-2 text-sm font-medium">
          <i data-lucide="refresh-cw" class="w-[18px] h-[18px]"></i>
          <span>終了</span>
        </button>
      </div>

      <div class="flex flex-col items-end gap-1 overflow-hidden w-full md:w-auto text-right">
        <div id="fileBadge" class="hidden items-center gap-2 bg-emerald-50 text-emerald-700 px-3 py-1 rounded-full text-sm font-medium border border-emerald-100 max-w-full">
          <i data-lucide="shield-check" class="w-[14px] h-[14px] shrink-0"></i>
          <span id="fileNameText" class="truncate"></span>
        </div>

        <span id="noFileText" class="text-slate-400 text-sm flex items-center gap-1">
          <i data-lucide="info" class="w-[14px] h-[14px]"></i>
          <span>ファイル未選択</span>
        </span>
      </div>
    </div>

    <!-- Error -->
    <div id="errorBox" class="hidden bg-red-50 border border-red-100 text-red-600 p-4 rounded-xl flex items-center gap-3 animate-in fade-in slide-in-from-top-2">
      <i data-lucide="x-circle" class="w-5 h-5"></i>
      <p id="errorText" class="font-medium text-sm"></p>
    </div>

    <!-- Viewer -->
    <div class="relative">
      <div class="relative bg-slate-900 rounded-[2rem] overflow-hidden shadow-2xl border-[6px] border-slate-800 h-[600px] md:h-[700px] w-full flex flex-col">

        <!-- Fake browser chrome -->
        <div class="h-10 bg-slate-800 flex items-center px-5 gap-2 shrink-0 border-b border-slate-700/50">
          <div class="flex gap-1.5 mr-4">
            <div class="w-3 h-3 rounded-full bg-rose-500/90 shadow-inner"></div>
            <div class="w-3 h-3 rounded-full bg-amber-500/90 shadow-inner"></div>
            <div class="w-3 h-3 rounded-full bg-emerald-500/90 shadow-inner"></div>
          </div>

          <div class="flex-1 flex justify-center mr-16">
            <div id="tabName"
              class="bg-slate-900/50 px-4 py-1 rounded-md text-[11px] font-mono text-slate-400 truncate max-w-xs border border-slate-700/30 italic">
              standalone-sandbox
            </div>
          </div>
        </div>

        <!-- iframe or placeholder -->
        <iframe id="sandboxFrame"
          class="hidden w-full h-full bg-white border-none"
          title="Sandbox"
          sandbox="allow-scripts allow-forms allow-same-origin allow-modals"></iframe>

        <div id="placeholder" class="flex-1 flex flex-col items-center justify-center text-slate-400 p-12 text-center space-y-6">
          <div class="w-20 h-20 rounded-3xl bg-slate-800/80 flex items-center justify-center border border-slate-700 shadow-inner">
            <i data-lucide="monitor" class="w-10 h-10 text-indigo-400 opacity-40"></i>
          </div>
          <div>
            <h3 class="text-xl font-semibold text-slate-200">ビューワー待機中</h3>
            <p class="text-sm text-slate-500 max-w-xs mx-auto mt-2">HTMLファイルを読み込むとここに表示されます。</p>
          </div>
        </div>

      </div>
    </div>

    <!-- Footer -->
    <footer class="text-center text-slate-400 text-xs pb-8 flex flex-col items-center gap-2">
      <div class="flex items-center gap-4 opacity-60 font-medium uppercase tracking-widest">
        <span>Safe Local Execution</span>
        <span>•</span>
        <span>Zero Server Latency</span>
      </div>
    </footer>

  </div>

  <script>
    // ---- lucide init ----
    if (window.lucide) window.lucide.createIcons();

    // ---- state ----
    let appUrl = null;

    // ---- elements ----
    const fileInput = document.getElementById("fileInput");
    const pickBtn = document.getElementById("pickBtn");
    const resetBtn = document.getElementById("resetBtn");

    const errorBox = document.getElementById("errorBox");
    const errorText = document.getElementById("errorText");

    const fileBadge = document.getElementById("fileBadge");
    const fileNameText = document.getElementById("fileNameText");
    const noFileText = document.getElementById("noFileText");
    const tabName = document.getElementById("tabName");

    const iframe = document.getElementById("sandboxFrame");
    const placeholder = document.getElementById("placeholder");

    // ---- helpers ----
    function revokeUrl(url) {
      if (!url) return;
      try { URL.revokeObjectURL(url); } catch (_) {}
    }

    // FileList → File を「壊されにくい」取り方で固定
    function getFirstFile(files) {
      if (!files) return null;
      if (typeof files.item === "function") return files.item(0);
      if (typeof files.length === "number" && files.length > 0) return files[0] || null;
      return null;
    }

    function isHtmlFile(file) {
      if (!file) return false;
      const name = (file.name || "").toLowerCase();
      const byExt = name.endsWith(".html") || name.endsWith(".htm");
      const byMime = (file.type || "").toLowerCase() === "text/html";
      return byExt || byMime;
    }

    function setError(msg) {
      if (!msg) {
        errorBox.classList.add("hidden");
        errorText.textContent = "";
        return;
      }
      errorText.textContent = msg;
      errorBox.classList.remove("hidden");
      // もしlucideが後から来た場合にも一応更新
      if (window.lucide) window.lucide.createIcons();
    }

    function setRunningUI(fileName) {
      resetBtn.classList.remove("hidden");

      fileBadge.classList.remove("hidden");
      fileBadge.classList.add("flex");
      noFileText.classList.add("hidden");

      fileNameText.textContent = fileName || "";
      tabName.textContent = fileName || "standalone-sandbox";

      placeholder.classList.add("hidden");
      iframe.classList.remove("hidden");

      if (window.lucide) window.lucide.createIcons();
    }

    function setIdleUI() {
      resetBtn.classList.add("hidden");

      fileBadge.classList.add("hidden");
      fileBadge.classList.remove("flex");
      noFileText.classList.remove("hidden");

      fileNameText.textContent = "";
      tabName.textContent = "standalone-sandbox";

      iframe.classList.add("hidden");
      placeholder.classList.remove("hidden");

      if (window.lucide) window.lucide.createIcons();
    }

    function resetAll() {
      revokeUrl(appUrl);
      appUrl = null;

      iframe.removeAttribute("src");
      setError("");
      setIdleUI();

      if (fileInput) fileInput.value = "";
    }

    // ---- events ----
    pickBtn.addEventListener("click", () => fileInput.click());
    resetBtn.addEventListener("click", resetAll);

    fileInput.addEventListener("change", (e) => {
      const file = getFirstFile(e.target && e.target.files);
      if (!file) return;

      setError("");

      if (!isHtmlFile(file)) {
        setError("HTML形式のファイル（.html / .htm）を選択してください。");
        if (fileInput) fileInput.value = "";
        return;
      }

      const reader = new FileReader();

      reader.onload = (ev) => {
        try {
          const content = ev.target && ev.target.result;
          if (typeof content !== "string") throw new Error("FileReader result is not a string.");

          // old URL cleanup
          revokeUrl(appUrl);

          const blob = new Blob([content], { type: "text/html" });
          appUrl = URL.createObjectURL(blob);

          iframe.src = appUrl;
          setRunningUI(file.name);
        } catch (err) {
          console.error(err);
          setError("データの生成に失敗しました。");
        }
      };

      reader.onerror = () => setError("ファイルの読み取り中にエラーが発生しました。");

      reader.readAsText(file);
    });

    // cleanup on unload
    window.addEventListener("beforeunload", () => revokeUrl(appUrl));

    // initial UI
    setIdleUI();
  </script>
</body>
</html>
