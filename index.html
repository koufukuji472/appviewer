<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Web Runner v1.2</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { margin: 0; display: flex; flex-direction: column; height: 100vh; font-family: sans-serif; background: #0f172a; color: white; }
        #launcher { padding: 15px 20px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #334155; }
        #log-window { padding: 10px 20px; background: #1e293b; font-family: monospace; font-size: 0.75rem; color: #94a3b8; border-bottom: 1px solid #334155; max-height: 80px; overflow-y: auto; }
        #display-area { flex-grow: 1; position: relative; background: #f8fafc; margin: 10px; border-radius: 12px; overflow: hidden; color: #333; }
        iframe { width: 100%; height: 100%; border: none; }
        .success { color: #4ade80; }
        .error { color: #f87171; font-weight: bold; }
    </style>
</head>
<body>

    <div id="launcher">
        <span style="font-weight:900;">WebRunner <span style="color:#60a5fa;">v1.2</span></span>
        <input type="file" id="fileInput" accept=".txt,.js,.jsx,.html" style="font-size: 0.8rem;">
        <button onclick="location.reload()" style="font-size: 0.7rem; background:#334155; padding:4px 8px; border-radius:4px;">リセット</button>
    </div>

    <div id="log-window">システム待機中...</div>

    <div id="display-area">
        <div id="react-root"></div>
        <iframe id="html-frame" style="display:none;"></iframe>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const logWindow = document.getElementById('log-window');
        const reactRoot = document.getElementById('react-root');
        const htmlFrame = document.getElementById('html-frame');

        function addLog(msg, isError = false) {
            const time = new Date().toLocaleTimeString();
            const className = isError ? 'error' : 'success';
            logWindow.innerHTML += `<div>[${time}] <span class="${className}">${msg}</span></div>`;
            logWindow.scrollTop = logWindow.scrollHeight;
        }

        // ライブラリチェック
        window.onload = () => {
            if (window.Babel && window.React) {
                addLog("システム正常：React/Babel 読み込み完了");
            } else {
                addLog("致命的エラー：外部ライブラリがブロックされています。Safariで開いてください。", true);
            }
        };

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files;
            if (!file) return;

            addLog(`ファイル検知: ${file.name}`);
            
            try {
                const code = await file.text();
                addLog(`テキスト読み込み完了 (${code.length} 文字)`);

                const isHTML = code.trim().toLowerCase().startsWith('<!doctype') || code.includes('<html');

                if (isHTML) {
                    addLog("HTMLモードとして描画します...");
                    renderAsHTML(code);
                } else {
                    addLog("Reactモードとして解析を開始...");
                    renderAsReact(code);
                }
            } catch (err) {
                addLog(`ファイル読込エラー: ${err.message}`, true);
            }
        });

        function renderAsHTML(code) {
            reactRoot.innerHTML = "";
            htmlFrame.style.display = "block";
            htmlFrame.srcdoc = code;
            addLog("描画完了しました");
        }

        function renderAsReact(code) {
            htmlFrame.style.display = "none";
            reactRoot.innerHTML = "解析中...";

            try {
                addLog("JSXからJavaScriptへの翻訳を開始...");
                const cleanCode = code.replace(/^import.*from.*;/gm, '');
                
                const transformedCode = Babel.transform(cleanCode, { 
                    presets: ['react'] 
                }).code;
                addLog("翻訳成功。実行環境を構築中...");

                const fullCode = `
                    const { useState, useEffect, useRef } = React;
                    const { ${Object.keys(Lucide).join(', ')} } = Lucide;
                    ${transformedCode}
                    if (typeof App === 'undefined') {
                        throw new Error("ファイル内に 'function App()' が見つかりません。");
                    }
                    const root = ReactDOM.createRoot(document.getElementById('react-root'));
                    root.render(React.createElement(App));
                `;

                reactRoot.innerHTML = "";
                new Function('React', 'ReactDOM', 'Lucide', fullCode)(React, ReactDOM, Lucide);
                addLog("Reactアプリを起動しました");
                
                setTimeout(() => { if(window.lucide) lucide.createIcons(); }, 100);

            } catch (err) {
                addLog(`React解析エラー: ${err.message}`, true);
                reactRoot.innerHTML = `<div style="padding:20px; color:red;">エラー詳細: ${err.message}</div>`;
            }
        }
    </script>
</body>
</html>

