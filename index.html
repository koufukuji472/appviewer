 <!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HTML App Viewer (Max)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root { --vh: 100vh; }
    body { height: var(--vh); }
  </style>
</head>

<body class="m-0 p-0 bg-slate-950 text-slate-100">
  <div class="h-full w-full flex flex-col">

    <!-- Top Bar (1行) -->
    <div class="shrink-0 px-2 py-2 bg-slate-900/90 border-b border-slate-800 flex items-center gap-2">
      <input id="fileInput" type="file" accept=".html,.htm,text/html" class="hidden" />

      <button id="pickBtn"
        class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 active:scale-[0.99] text-white text-sm font-semibold">
        <i data-lucide="file-up" class="w-4 h-4"></i>
        <span>選択</span>
      </button>

      <button id="resetBtn"
        class="hidden inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 active:scale-[0.99] text-slate-100 text-sm font-semibold">
        <i data-lucide="x" class="w-4 h-4"></i>
        <span>終了</span>
      </button>

      <div class="min-w-0 flex-1">
        <div class="text-xs text-slate-400 leading-none">Loaded</div>
        <div id="fileNameText" class="text-sm font-mono truncate text-slate-200">none</div>
      </div>

      <div id="errorBadge"
        class="hidden items-center gap-2 px-3 py-2 rounded-lg bg-rose-950/60 border border-rose-900 text-rose-200 text-xs font-semibold">
        <i data-lucide="alert-circle" class="w-4 h-4"></i>
        <span id="errorText">error</span>
      </div>
    </div>

    <!-- Stage (almost fullscreen) -->
    <!-- ★ここに relative を付けるのが超重要 -->
    <div class="flex-1 min-h-0 bg-black relative">
      <iframe id="sandboxFrame"
        class="w-full h-full bg-white border-none"
        title="Sandbox"
        sandbox="allow-scripts allow-forms allow-same-origin allow-modals"></iframe>

      <!-- placeholder overlay (only when no app) -->
      <div id="placeholder"
        class="z-10 absolute inset-0 flex items-center justify-center bg-slate-950 text-slate-400">
        <div class="text-center space-y-3 px-6">
          <div class="mx-auto w-12 h-12 rounded-2xl bg-slate-900 flex items-center justify-center border border-slate-800">
            <i data-lucide="monitor" class="w-6 h-6"></i>
          </div>
          <div class="text-sm">
            <div class="font-semibold text-slate-200">待機中</div>
            <div class="text-slate-400">上の「選択」からHTMLを読み込んでください</div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    function setVh() {
      document.documentElement.style.setProperty("--vh", window.innerHeight + "px");
    }
    setVh();
    window.addEventListener("resize", setVh);

    if (window.lucide) window.lucide.createIcons();

    let appUrl = null;

    const fileInput = document.getElementById("fileInput");
    const pickBtn = document.getElementById("pickBtn");
    const resetBtn = document.getElementById("resetBtn");
    const iframe = document.getElementById("sandboxFrame");
    const placeholder = document.getElementById("placeholder");

    const fileNameText = document.getElementById("fileNameText");
    const errorBadge = document.getElementById("errorBadge");
    const errorText = document.getElementById("errorText");

    function revokeUrl(url) {
      if (!url) return;
      try { URL.revokeObjectURL(url); } catch (_) {}
    }

    function getFirstFile(files) {
      if (!files) return null;
      if (typeof files.item === "function") return files.item(0);
      if (typeof files.length === "number" && files.length > 0) return files[0] || null;
      return null;
    }

    function isHtmlFile(file) {
      if (!file) return false;
      const name = (file.name || "").toLowerCase();
      const byExt = name.endsWith(".html") || name.endsWith(".htm");
      const byMime = (file.type || "").toLowerCase() === "text/html";
      return byExt || byMime;
    }

    function showError(msg) {
      if (!msg) {
        errorBadge.classList.add("hidden");
        errorText.textContent = "";
        return;
      }
      errorText.textContent = msg;
      errorBadge.classList.remove("hidden");
      if (window.lucide) window.lucide.createIcons();
    }

    function setLoadedUI(name) {
      resetBtn.classList.remove("hidden");
      fileNameText.textContent = name || "loaded";
      placeholder.classList.add("hidden");
      if (window.lucide) window.lucide.createIcons();
    }

    function setIdleUI() {
      resetBtn.classList.add("hidden");
      fileNameText.textContent = "none";
      placeholder.classList.remove("hidden");
      if (window.lucide) window.lucide.createIcons();
    }

    function resetAll() {
      revokeUrl(appUrl);
      appUrl = null;
      iframe.removeAttribute("src");
      showError("");
      setIdleUI();
      if (fileInput) fileInput.value = "";
    }

    pickBtn.addEventListener("click", () => fileInput.click());
    resetBtn.addEventListener("click", resetAll);

    fileInput.addEventListener("change", (e) => {
      const file = getFirstFile(e.target && e.target.files);
      if (!file) return;

      showError("");

      if (!isHtmlFile(file)) {
        showError("HTML（.html/.htm）を選んでください");
        if (fileInput) fileInput.value = "";
        return;
      }

      const reader = new FileReader();

      reader.onload = (ev) => {
        try {
          const content = ev.target && ev.target.result;
          if (typeof content !== "string") throw new Error("FileReader result is not a string.");

          revokeUrl(appUrl);

          const blob = new Blob([content], { type: "text/html" });
          appUrl = URL.createObjectURL(blob);

          iframe.src = appUrl;
          setLoadedUI(file.name);
        } catch (err) {
          console.error(err);
          showError("読み込みに失敗しました");
        }
      };

      reader.onerror = () => showError("ファイル読み取りエラー");

      reader.readAsText(file);
    });

    window.addEventListener("beforeunload", () => revokeUrl(appUrl));

    setIdleUI();
  </script>
</body>
</html>
